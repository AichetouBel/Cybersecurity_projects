#####################################################################
#######                AUTHOR: AICHETOU BEL                   #######                       
#####################################################################

# Pentesting with nmap

Dans cette documentation nous allons faire des tests d'intrusions sur notre SOC avec la commande NMAP qui permet de scanner les ports ouvertd sur un réseau donné.

La détection sur notre SOC ce fait à travers Suricata  et pour faire ceci nous allons procéder comme suit.


## Partie 1: Créer une règle dans suricata

premièrment nous allons commencer par la création d'une régle dans suricata qui va permettre de détecter l'utilisation de nmap sur notre réseau.

1. Télécharger filezilla avec la commande suivante: ``sudo apt install filezilla``.
Filezilla est un client FTP, FTPS et SFTP, développé sous la licence publique générale GNU. Il va nous permettre de transférer les fichiers entre notre ordinateur et le firewall.
2. Créer un dossier: ``mkdir suricata_rules``

3. Dans le dossier suricata_rules créer deux fichiers ``nmap.rules`` et ``nmap.xml``:
    * ``sudo touch nmap.rules``
    * ``sudo touch nmap.xml``

4. Dans le fichier nmap.rule on va écrire notre règle suricata de détection de nmap

``` C
alert tcp any any -> 192.168.1.1/24 any (msg:"POSSIBLE NMAP SCAN DETECTED"; flow:stateless; flags:S; priority:5; threshold:type threshold, track by_src, count 50, seconds 1; classtype:attempted-recon; sid:1100110;)

```
avec 192.168.1.1 est l'adresse IP du firewall.

5. Dans le fichier nmap.xml nous allons mettre l'endroit dans lequel le fichier nmap.rule va être téléchargé via un serveur http et enregistrer avec les règles de suricata sur notre firewall.

``` XML

<ruleset documentation_url="http://docs.opnsense.org/">
<location url="http://192.168.1.209:8888/" prefix="nmap"/>
<files>
<file description="custom nmap rules">nmap.rules</file>
<file description="Custom nmap" url="inline::rules/nmap.rules">nmap.rules</file>
</files>
</ruleset>

```

 l'ordinateur sur laquelle sont stocker les deux fichiers ``nmap.rules`` et ``nmap.xml``

6. Maintenant nous allons utiliser le serveur http de python3 avec la commande suivante: python3 -m http.server 8888
``NB:`` Cette commande doit être lancée à partir de l'emplacement du dossier suricata-rules et faire attention à https une telle connexion ne peut pas être établis, uniquement http.

7. pour pouvoir accéder au dossier de firewall nous devons activer la connexion ssh sur le firewall qui est désactivé par défaut. 
* Aller chez l'interface graphique d'Opensense System > Settings > Administration, balayer vers le bas vous trouvez des champs pour configurer ssh
    * cochez la case ``Enable Secure Shell`` pour activer le ssh
    * Pour se connecter en tant que root, cochez ``Permit root user login``  
    * si vous utilisez la méthode d'authentification par mot de passe, cochez ``Permit password login``.
    * Précisez le port 22
    * Balayer vers le bas et cliquer sur ``save``
8. Ouvrez Filezilla dans un terminal lunix en tapant la commande suivante ``filezilla``
    * Une fenêtre va s'ouvrir remplir les champs dans l'entête de la fenêtre en mettant l'adresse IP de l'interface graphique du firewall, vos identifiants de firewall et le port de shh ``22``.
    * Dans le dossier /usr/local/opnsense/scripts/suricata/metadata/rules/ copier le fichier ``nmap.xml``
9. Allez vers l'interface graphique du firewall services > Intrusion detection > Administration > Download 
    * En haut à gauche, cliquer sur l'icône demi-cercle pour redémarrer le service
Si votre configuration est bonne vous devez voir votre règle parmis le régles de suricata.
    * Cochez votre règle puis cliquez sur ``Download & Update Rules`` pour l'installer.
 
# Tester la règle
Pour tester notre règle nous avons utilisé une machine kali connéctée sur le réseau LAN de notre firewall.

1. Ouvrez une terminale sur votre machine kali et tapez la commande suivante:
    * `` sudo nmap -sS -Pn --top-ports 500 $DEVISE_IP_ADDRESS ``
2. Revenez sur l'interface graphique de votre firewall services > Intrusion detection > Administration > Alert et vous devez voir une alerte comme quoi l'adresse IP de votre machine kali  à essayer de scanner votre réseau avec la commande NMAP.

# Troubleshooting

* Si vous aurez le problème du port qui est déjà utilisé après avoir utilisé le serveur web de python, vous devez juste changer le port et faire les changements dans votre fichier xml
* Si vous n'avez pas python3 installez-le à côté de python 2 ne supprimez pas python2 car lunix l'utilise et cela peut causer des dysfonctionnements dans votre système.